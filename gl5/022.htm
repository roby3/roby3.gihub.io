<html>
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1251">
<meta http-equiv="Content-Language" content="uk">
<link rel=Edit-Time-Data href=../tmp/5.3.6_u.files/editdata.mso>
<title>5.3.6. Фрагментація IP-пакетів</title>
</head>
<body lang=Ua>
<h3>5.3.6. Фрагментація IP-пакетів</h3>
<p>Протокол IP дозволяє виконувати
фрагментацію пакетів, що надходять на вхідні
порти маршрутизаторів.</p>
<p>Доцільно розрізняти фрагментацію
повідомлень у вузлі-відправнику й динамічну фрагментацію повідомлень у
транзитних вузлах мережі - маршрутизаторах.
Практично у всіх стеках протоколів є протоколи, які відповідають за
фрагментацію повідомлень прикладного рівня на такі частини, які укладаються в
кадри канального рівня. У стеці TCP/IP це завдання
вирішує протокол TCP, що розбиває потік байтів, переданий
йому із прикладного рівня на повідомлення потрібного розміру (наприклад, на
1460&nbsp;байт для протоколу Ethernet). Тому протокол IP у вузлі-відправнику не
використовує свої можливості по фрагментації
пакетів.</p>
<p>А от
при необхідності передати пакет у наступну мережу,
для якої розмір пакета є занадто великим, IP-фрагментація стає необхідною. У функції
рівня IP входить розбивка занадто довгого для конкретного типу складової мережі повідомлення на більше
короткі пакети зі створенням відповідних службових
полів, потрібних
для наступного складання фрагментів у вихідне
повідомлення.</p>
<p>У більшості типів локальних і
глобальних мереж значення MTU, тобто
максимальний розмір поля даних, у яке повинен інкапсулювати
свій пакет протокол IP, значно відрізняється. Мережі
Ethernet мають значення MTU, що дорівнює 1500&nbsp;байт, мережі FDDI – 4096&nbsp;байт, а мережі Х.25 найчастіше працюють із MTU в 128&nbsp;байт.</p>
<p>IP-пакет може бути позначений як такий,
що не фрагментується. Любою пакет, позначений таким чином, не може бути фрагментованим модулем IP ні при яких умовах. Якщо ж
пакет, позначений як не фрагментований, не може досягти одержувача без
фрагментації, то цей пакет просто знищується, а вузлу-відправникові посилає
відповідне ICMP-повідомлення.</p>
<p>Протокол IP допускає можливість використання в межах окремої підмережі її
власних засобів фрагментування,
невидимих для протоколу IP. Наприклад,
технологія ATM ділить поступаючи IP-пакети на комірки з полем
даних в 48&nbsp;байт за допомогою свого рівня
сегментування, а потім збирає комірки у
вихідні пакети на виході з мережі. Але такі
технології, як ATM, є скоріше виключенням, ніж
правилом.</p>
<p>Процедури фрагментації й складання протоколу IP розраховані на те, щоб пакет
міг бути розбитий на практично будь-яку кількість частин, які згодом могли б
бути знову зібрані. Одержувач фрагмента використовує
поле ідентифікації для того, щоб не переплутати фрагменти різних пакетів.
Модуль IP, що відправляє пакет, встановлює в поле ідентифікації значення, яке повинне бути унікальним для даної пари відправник - одержувач, а
також час, протягом якого пакет може бути активним
у мережі.</p>
<p>Поле зсуву фрагмента повідомляє одержувачеві положення
фрагмента у вихідному пакеті. Зсув фрагмента й довжина визначають
частину вихідного пакета, принесену цим
фрагментом. Прапор «more fragments» показує появу
останнього фрагмента. Модуль протоколу IP, що відправляє нерозбитий на фрагменти пакет, встановлює в нуль прапор «more fragments» і зсув у
фрагменті.</p>
<p>Ці поля дають достатню кількість інформації для зборки пакета.</p>
<p>Щоб розділити на фрагменти
великий пакет, модуль протоколу IP, встановлений,
наприклад, на маршрутизаторі, створює кілька нових пакетів і копіює вміст полів IP-заголовка з великого пакета в IP-заголовки
всіх нових пакетів. Дані зі старого пакета діляться на відповідне число частин,
розмір кожної з яких, крім самої останньої, обов'язково повинен бути кратним 8 байт. Розмір останньої частини даних
дорівнює отриманому залишку.</p>
<p>Кожна з отриманих частин даних міститься в новий пакет. Коли відбувається
фрагментація, те деякі параметри IP-заголовка копіюються в заголовки всіх
фрагментів, а інші залишаються лише в
заголовку першого фрагмента. Процес фрагментації може змінити значення даних, розташованих у полі
параметрів, і значення контрольної суми заголовка, змінити значення прапора «mоrе fragments» і зсув фрагмента, змінити довжину
IP-заголовка й загальну довжину пакета. У
заголовок кожного пакета заносяться відповідні значення в поле зсуву «fragment offset», а в поле загальної
довжини пакета міститься довжина кожного
пакета. Перший фрагмент буде мати в полі
«fragment offset» нульове значення. У всіх пакетах, крім останнього, прапор «more fragments» встановлюється в одиницю, а в останньому фрагменті -
у нуль.</p>
<p>Щоб зібрати фрагменти пакета,
модуль протоколу IP (наприклад, модуль на хост-комп'ютері) поєднує IP-пакети, що мають однакові значення в
полях ідентифікатора, відправника, одержувача й протоколу. Таким чином,
відправник повинен вибрати ідентифікатор таким чином, щоб він був унікальний
для даної пари відправник-одержувач, для даного протоколу й протягом того часу,
поки даний пакет (або будь-який його фрагмент) може існувати в складеній IP-мережі.</p>
<p>Очевидно, що модуль протоколу IP,
що відправляє пакети, повинен мати таблицю ідентифікаторів, де кожна запис
співвідноситься з кожним окремим одержувачем, з яким здійснювався зв'язок,
і вказує останнє значення максимального часу життя
пакета в IP-мережі. Однак, оскільки поле ідентифікатора допускає 65&nbsp;536 різних значень, деякі хости можуть використовувати
просто унікальні ідентифікатори, що не залежать від адреси одержувача.</p>
<p>У деяких випадках доцільно, щоб
ідентифікатори IP-пакетів вибиралися протоколами більш
високого, ніж
IP, рівня. Наприклад, у протоколі TCP передбачена повторна передача
TCP-сегментів, що за якимись причинами не дійшли до адресата. Імовірність
правильного прийому збільшувалася б, якби при
повторній передачі ідентифікатор для IP-пакета був би тим же, що й у вихідному
IP-пакеті, оскільки його фрагменти могли б використатися
для складання правильного Тср - сегмента.</p>
<p>Процедура об'єднання полягає в приміщенні даних з кожного фрагмента в
позицію, зазначену в заголовку пакета в поле «fragment offset».</p>
<p>Кожен модуль IP повинен бути здатний передати пакет з 68&nbsp;байт без подальшої
фрагментації. Це пов'язане з тим, що IP-заголовок може включати до 60&nbsp;байт,
а мінімальний фрагмент даних – 8&nbsp;байт. Кожен
одержувач повинен могти прийняти пакет з 576&nbsp;байт як єдиний шматок або у
вигляді фрагментів, що підлягають зборці.</p>
<p>Якщо біт прапора заборони
фрагментації (Don't Fragment, DF) встановлений, то фрагментація даного пакета
заборонена, навіть якщо в цьому випадку він буде загублений. Даний засіб може використовуватися
для запобігання фрагментації в тих випадках, коли хост-отримувач
не має достатніх ресурсів для складання
фрагментів.</p>
<p>Робота протоколу IP по
фрагментації пакетів у хостах і маршрутизаторах
ілюструється на мал. 5.21.</p>
<p>Нехай <b>комп'ютер 1</b> пов'язаний з мережею,
що має значення MTU в 4096&nbsp;байт, наприклад з
мережею FDDI. При надходженні на IP-рівень <b>комп'ютера 1</b> повідомлення від транспортного
рівня розміром в 5600&nbsp;байт протокол IP ділить
його на два
IP-пакети, встановлюючи в першому пакеті ознаку фрагментації й привласнюючи
пакету унікальний ідентифікатор, наприклад
486. У першому пакеті розмір поля зсуву дорівнює 0, а в другому
- 2800. Ознака фрагментації в другому пакеті
дорівнює нулю, що показує, що це останній
фрагмент пакета. Загальна величина IP-пакета становить
2800 плюс 20 (розмір IP-заголовка), тобто 2820&nbsp;байт, що вміщається в поле даних кадру FDDI. Далі модуль IP 
<b>комп'ютера 1</b> передає ці пакети своєму мережевому інтерфейсу
(утвореному протоколами канального рівня К1 і
фізичного рівня Ф1). Мережний інтерфейс
відправляє кадри наступному маршрутизатору.</p>
<table border="0" width="100%" id="table1">
	<tr>
		<td align="center">
		<img width=490 height=426 src=images/im021.jpg alt="Мал. 5.21. Фрагментація IP-пакетів при передачі між мережами з різним максимальним розміром пакетів"></td>
	</tr>
	<tr>
		<td align="center">Мал. 5.21. Фрагментація
IP-пакетів при передачі між мережами з різним максимальним розміром пакетів: <br>
		К1
і Ф1 — канальний і фізичний рівень мережі 1;<br>
		К2
і Ф2 — канальний і фізичний рівень мережі 2</td>
	</tr>
</table>
<p>Після того, як кадри пройдуть рівень мережевого
інтерфейсу маршрутизатора (К1 і Ф1) і звільняться від заголовків FDDI, модуль
IP по мережевій адресі визначає, що прибулі два пакети
потрібно передати в <b>мережу 2</b>, що є мережею Ethernet і має значення MTU, яка дорівнює
1500. Отже, що прибули IP-пакети необхідно фрагментувати.
Маршрутизатор витягає поле даних з кожного пакета й ділить
його ще навпіл, щоб кожна частина вмістилася в поле
даних кадру Ethernet. Потім він формує нові IP-пакети, кожний
з яких має довжину 1400 + 20 = 1420&nbsp;байт, яке менше 1500&nbsp;байт, тому
вони нормально поміщаються в поле даних кадрів Ethernet.</p>
<p>У результаті в <b>комп'ютер 2</b> по мережі
Ethernet приходять чотири IP-пакети із загальним
ідентифікатором 486, що дозволяє протоколу IP,
який працює в <b>комп'ютері 2</b>,
правильно зібрати вхідне повідомлення. Якщо пакети прийшли
не в тому порядку, у якому були послані, то зсув укаже правильний порядок
їхнього об'єднання.</p>
<p>Відзначимо, що IP-маршрутизатори
не збирають фрагменти пакетів у великі пакети, навіть якщо на шляху зустрічається мережа,
що допускає таке укрупнення. Це пов'язане з
тим, що окремі фрагменти повідомлення можуть переміщатися по інтермережі по
різних маршрутах, тому немає гарантії, що всі фрагменти проходять через
який-небудь проміжний маршрутизатор на їхньому шляху.</p>
<p>При приході першого фрагмента
пакета вузол призначення запускає таймер, що визначає
максимально припустимий час очікування приходу
інших фрагментів цього пакета. Таймер встановлюється
на максимальне із двох значень: початковий
настановний час очікування й час життя, зазначені в прийнятому фрагменті. Таким чином, первісна установка
таймера є нижньою границею
для часу очікування при зборці. Якщо таймер минає
раніше прибуття останнього фрагмента, то всі
ресурси зборки, пов'язані з даним пакетом,
звільняються, всі отримані до цього моменту
фрагменти пакета відкидаються, а у вузол, що послав вихідний пакет, направляється повідомлення про помилку за допомогою
протоколу ICMP.</p>
<table border="0" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="table1">
  <tr>
    <td width="100%" align="left" colspan="3"><hr color="#2D4C54" size="4"></td>
  </tr>
  <tr>
    <td width="33%" align="left"><a href="021.htm">Попередня</a></td>
    <td width="33%" align="center"><a href="001.htm">Перша</a></td>
    <td width="34%" align="right"><a href="023.htm">Наступна</a></td>
  </tr>
</table></body>
</html>
